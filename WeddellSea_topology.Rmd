---
title: 'New insights into the Weddell Sea ecosystem: a network approach'
author: "Tomás I. Marina, Leonardo A. Saravia, Susanne Kortsch, Georgina Cordone, Vanesa Salinas, Iara D. Rodríguez and Fernando R. Momo"
date: "12/15/2020"
output: html_document
bibliography: MetawebsAssembly.bib
---

```{r global_setting, echo=FALSE}
knitr::opts_chunk$set(fig.path="Figures/", message=FALSE, warning=FALSE)
```

# 1. Introduction

\newpage

# 2. Methodology

This network is an update version of the highly-resolved Weddell Sea food web [@jacob2005].
Most of the Weddell Sea food web consumers are benthic invertebrates and fish species, with four trophic entities (detritus, sediment, necromass and bacteria), forming important basal resources. Species were not divided further into larvae, juveniles or adults but treated as ‘adults’: consequently, with the data used here, we cannot address ontogenetic diet shifts.

```{r data_load}
# Load data
weddell_nodes <- read.csv("Data/weddell_nodes.csv", header = TRUE)
weddell_links <- read.csv("Data/weddell_links.csv", header = TRUE)
```

\newpage

# 3. Results

```{r network_igraph}
# Load libraries
library(igraph)
library(multiweb)
library(RColorBrewer)
library(dplyr)

# Create igraph object
g <- igraph::graph_from_data_frame(weddell_links, directed = TRUE, vertices = weddell_nodes)
```

# 3.1 Global-level analysis

```{r global_analysis, results='asis'}

## Calculate topological indices
topol_ind <- multiweb::calc_topological_indices(g)

## Calculate small-worldness and modularity
network_random <- lapply(1:100, function (x) {
  e <- sample_gnm(topol_ind$Size, topol_ind$Links, directed = TRUE)

  # Check that the Erdos-Renyi networks have only one connected component
  while(components(e)$no > 1)
    e <- igraph::erdos.renyi.game(topol_ind$Size, topol_ind$Links, type = "gnm", directed = TRUE)
  return(e) 
  }
)

# 'calc_modularity_swness_zscore' function compares small-world related properties
# (characteristic path length and clustering coefficient) and modularity between random
# and empirical networks using Z scores
sw_mod <- multiweb::calc_modularity_swness_zscore(g, nullDist = network_random)  # this takes a while

## Calculate trophic level and omnivory index
adj_matrix <- get.adjacency(g, sparse = FALSE)
tl_om <- round(TrophInd(adj_matrix), digits = 3)
# Trophic level for each species
tl <- tl_om[,1]

## Calculate degree and degree distribution
degree_total <- degree(g, mode = "total")
degree_dist <- degree_distribution(g, cumulative = TRUE)
plot(degree_dist, xlab = "Degree", ylab = "Cumulative Degree Distribution")

## Plot food web by trophic level and degree
# Layout for trophic level
layout_matrix_tl <- matrix(nrow = length(V(g)), ncol = 2)
layout_matrix_tl[, 1] <- runif(length(V(g)))
layout_matrix_tl[, 2] <- tl

# Color and shape species by functional group
color.range <- brewer.pal(nlevels(as.factor(V(g)$group)), name = "Paired")
color.range <- colorRampPalette(color.range)(20)
V(g)$color  <- color.range[as.factor(V(g)$group)]
shapes <- ifelse(V(g)$group == "Non-living", "square", "circle")

# General food web graph
plot.igraph(g,
            vertex.size = degree_total * 0.25,
            vertex.label = "",
            vertex.shape = shapes,
            vertex.color = V(g)$color,
            layout = layout_matrix_tl,
            edge.width = .85,
            edge.arrow.size = 0.25)
legend("bottom",
       legend = levels(as.factor(V(g)$group)),
       col = color.range[as.numeric(as.factor(levels(as.factor(V(g)$group))))],
       pch = c(16,16,16,16,16,16,16,16,16,16,16,16,16,15,16,16,16,16,16,16),
       cex = 1,
       bg="transparent",
       bty = "n",
       ncol = 5)

## Table with global-level analysis results
global_table <- data.frame(Size = topol_ind$Size, Links = topol_ind$Links, 
                           Connectance = topol_ind$Connectance, TL = topol_ind$TLmean, 
                           q = "0", Omn = topol_ind$Omnivory, CPL = topol_ind$PathLength,
                           CC = topol_ind$Clustering, SW = sw_mod$da[,"isSW"]) %>% mutate_if(is.numeric, round, digits=3)

knitr::kable(global_table, caption = "Global-level network analysis of the Weddell Sea food web. TL = trophic level, q = trophic coherence, Omn = omnivory, CPL = characteristic path length, CC = clustering coefficient, SW = small-world")

```


# 3.2 Sub-network analysis

```{r subnetwork_analysis}

## Modularity
# Already calculated with 'calc_modularity_swness_zscore' function
subnetwork_table <- data.frame(Mod.obs = sw_mod$da[,"Modularity"], Mod.zscore = sw_mod$da[,"zMO"], Mod.CI.low = sw_mod$da[,"MOlow"], Mod.CI.high = sw_mod$da[,"MOhigh"]) %>% mutate_if(is.numeric, round, digits=4)

## Motifs

knitr::kable(subnetwork_table, caption = "Subnetwork-level network analysis of the Weddell Sea food web. Mod.obs = food web modularity, Mod.zscore = z_score of modularity, Mod.CI = low and high value for confidence interval null modularity")

```

# 3.3 Species-level analysis

```{r species_analysis}

## Centrality indices
# Closeness measures how many steps are required to access every other vertex 
# from a given vertex (in- or out-links), the higher the greater importance
# Betweenness measures how central a given node is in terms of being 
# included in many of the shortest paths in the network, the higher the greater importance

degree_total <- degree(g, mode = "total")
clo_in <- igraph::closeness(g, mode = "in", normalized = TRUE)    # normalized by S - 1
clo_out <- igraph::closeness(g, mode = "out", normalized = TRUE)  # normalized by S - 1
btw <- igraph::betweenness(g, v = V(g), directed = TRUE)          # normalized by S - 1

species_table <- data.frame(Species = weddell_nodes$name, Degree = degree_total, Betweenness = btw, 
                            Close.in = clo_in, Close.out = clo_out) %>% mutate_if(is.numeric, round, digits=4)

knitr::kable(species_table, caption = "Species-level network analysis describing of the Weddell Sea food web. Close.in and Close.out = closeness considering paths to and from a species, respectively")
```

\newpage

# 4. Discussion

# 5. References